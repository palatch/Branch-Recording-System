<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Offline)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Set Inter font as default -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+Thai:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Custom scrollbar for better appearance */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
    </style>
    <!-- Load SheetJS for Excel handling -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="p-4 md:p-8">

    <!-- Loading Overlay (kept for aesthetic during initial load, but hides instantly) -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
        <p class="ml-4 text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <!-- Main Application Content -->
    <div id="main-app-content" class="hidden max-w-7xl mx-auto">
        
        <header class="mb-6 pb-4 border-b border-blue-200">
            <h1 class="text-3xl font-extrabold text-blue-700">üìà ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)</h1>
            <p class="text-sm text-gray-500 mt-1" id="user-id-display">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
        </header>

        <!-- Control Panel: Add, Import, Export -->
        <div class="mb-6 flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4">
            
            <!-- Add Button -->
            <button onclick="openModal('add')" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">
                + ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            </button>

            <!-- Import/Export Group -->
            <div class="flex flex-grow space-x-2">
                <input type="file" id="import-file" accept=".xlsx,.csv" class="hidden" onchange="importData(event)">
                <button onclick="document.getElementById('import-file').click()" class="w-1/2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center justify-center text-sm md:text-base">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z" clip-rule="evenodd" /><path d="M10 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" /></svg>
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel
                </button>
                <button onclick="exportData()" class="w-1/2 bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center justify-center text-sm md:text-base">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-3.293-9.293a1 1 0 001.414 1.414L10 9.414l1.293 1.293a1 1 0 001.414-1.414l-2-2a1 1 0 00-1.414 0l-2 2z" clip-rule="evenodd" /></svg>
                    ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
                </button>
            </div>
        </div>

        <!-- Table Display -->
        <div class="bg-white p-4 rounded-xl shadow-lg overflow-x-auto custom-scrollbar">
            <table id="data-table" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-50">
                    <tr id="table-header-row">
                        <!-- Header will be dynamically generated here -->
                    </tr>
                </thead>
                <tbody id="table-body" class="bg-white divide-y divide-gray-200 text-sm">
                    <!-- Data rows will be dynamically generated here -->
                </tbody>
            </table>
            <!-- Summary Row -->
            <table class="min-w-full mt-4 text-sm font-bold border-t-2 border-blue-500">
                <tbody id="table-summary-row">
                    <!-- Summary row will be dynamically generated here -->
                </tbody>
            </table>

            <p id="empty-state" class="text-center text-gray-500 p-8 hidden">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            </p>
        </div>
    </div>

    <!-- Modal for Add/Edit Record -->
    <div id="data-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 duration-300">
            <h2 id="modal-title" class="text-xl font-bold mb-4 ">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
            <form id="record-form">
                <input type="hidden" id="record-id">
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <!-- Input: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Date Picker) -->
                    <div class="col-span-2 sm:col-span-1">
                        <label for="input-date" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</label>
                        <!-- Note: Using type="date" to capture YYYY-MM-DD. We will enforce the 1st of the month on save. -->
                        <input type="date" id="input-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                        <!-- Hidden inputs to store the Thai display format and the full date for sorting -->
                        <input type="hidden" id="month"> 
                        <input type="hidden" id="isoDate"> 
                    </div>
                    <!-- Input: ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö (RENAMED and now takes GROSS amount) -->
                    <div class="col-span-2 sm:col-span-1">
                        <label for="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö" class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö <span class="text-xs text-blue-500">(‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° VAT 7%)</span></label>
                        <input type="number" id="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" value="0" min="0">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <!-- Input: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤3 (Input NET/Pre-VAT) -->
                    <div>
                        <label for="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤3" class="block text-sm font-medium text-gray-700">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ 3% <span class="text-xs text-gray-400">(‡∏Å‡πà‡∏≠‡∏ô VAT)</span></label>
                        <input type="number" id="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" value="0" min="0">
                    </div>
                    <!-- Input: ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ (Input NET/Pre-VAT) -->
                    <div>
                        <label for="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥" class="block text-sm font-medium text-gray-700">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ <span class="text-xs text-gray-400">(‡∏Å‡πà‡∏≠‡∏ô VAT)</span></label>
                        <input type="number" id="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" value="0" min="0">
                    </div>
                    <!-- Input: ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (Input NET/Pre-VAT) -->
                    <div>
                        <label for="‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü" class="block text-sm font-medium text-gray-700">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü <span class="text-xs text-gray-400">(‡∏Å‡πà‡∏≠‡∏ô VAT)</span></label>
                        <input type="number" id="‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" value="0" min="0">
                    </div>
                    <!-- Input: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï (Input NET/Pre-VAT) -->
                    <div>
                        <label for="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï" class="block text-sm font-medium text-gray-700">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï <span class="text-xs text-gray-400">(‡∏Å‡πà‡∏≠‡∏ô VAT)</span></label>
                        <input type="number" id="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" value="0" min="0">
                    </div>
                    <!-- Input: ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Input NET/Pre-VAT) -->
                    <div>
                        <label for="‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á" class="block text-sm font-medium text-gray-700">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á <span class="text-xs text-gray-400">(‡∏Å‡πà‡∏≠‡∏ô VAT)</span></label>
                        <input type="number" id="‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" value="0" min="0">
                    </div>
                    <!-- Input: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢ (Input NET/Pre-VAT) -->
                    <div>
                        <label for="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢" class="block text-sm font-medium text-gray-700">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢ <span class="text-xs text-gray-400">(‡∏Å‡πà‡∏≠‡∏ô VAT)</span></label>
                        <input type="number" id="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" value="0" min="0">
                    </div>
                    <!-- Input: ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô25 (Input NET/Pre-VAT) -->
                    <div class="col-span-2">
                        <label for="‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô25" class="block text-sm font-medium text-gray-700">‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô 25% <span class="text-xs text-gray-400">(‡∏Å‡πà‡∏≠‡∏ô VAT)</span></label>
                        <input type="number" id="‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô25" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" value="0" min="0">
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-200">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button type="button" id="delete-btn" onclick="deleteRecord()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 hidden">
                        ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation/Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300">
            <h3 class="text-xl font-bold mb-3 text-red-600">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
            <p id="alert-message" class="mb-4 text-gray-700">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="window.confirmCallback(false)" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-200">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button onclick="window.confirmCallback(true)" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global data store to hold records for display, export, and localStorage manipulation
        window.dataStore = [];
        const LOCAL_STORAGE_KEY = 'monthly_expense_records';

        // --- Local Storage Management ---
        function saveRecordsToLocalStorage(records) {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(records));
        }

        function loadRecordsFromLocalStorage() {
            try {
                const json = localStorage.getItem(LOCAL_STORAGE_KEY);
                return json ? JSON.parse(json) : [];
            } catch (e) {
                console.error("Error loading records from localStorage:", e);
                return [];
            }
        }

        // --- Configuration & VAT Helpers ---
        const VAT_RATE = 0.07; 
        const VAT_FACTOR = 1 + VAT_RATE; // 1.07

        function toNet(gross) {
            // Converts Gross amount (‡∏£‡∏ß‡∏° VAT) to Net amount (‡∏Å‡πà‡∏≠‡∏ô VAT)
            return gross / VAT_FACTOR;
        }

        function toGross(net) {
            // Converts Net amount (‡∏Å‡πà‡∏≠‡∏ô VAT) to Gross amount (‡∏£‡∏ß‡∏° VAT)
            return net * VAT_FACTOR;
        }

        const THAI_MONTHS = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];

        function convertDateToThaiFormat(isoDate) {
            if (!isoDate) return '';
            try {
                const date = new Date(isoDate);
                const monthIndex = date.getMonth();
                const year = date.getFullYear() + 543; // Convert to Buddhist Era
                return `${THAI_MONTHS[monthIndex]}-${String(year).slice(-2)}`;
            } catch (e) {
                console.error("Invalid date format for conversion:", isoDate);
                return '';
            }
        }

        const COLUMN_CONFIG = [
            { key: 'month', header: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type: 'string', isEditable: false, isSummary: true, summaryLabel: '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô' },
            { key: 'isoDate', header: 'ISO Date', type: 'hidden', isEditable: false }, // Internal key for sorting
            { key: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö', header: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö', type: 'number', isEditable: true }, // **STORES NET AMOUNT**
            { key: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤3', header: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ 3%', type: 'number', isEditable: true },
            { key: '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥', header: '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥', type: 'number', isEditable: true },
            { key: '‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü', header: '‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü', type: 'number', isEditable: true },
            { key: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï', header: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï', type: 'number', isEditable: true },
            { key: '‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', header: '‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', type: 'number', isEditable: true },
            { key: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢', header: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢', type: 'number', isEditable: true },
            { key: '‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô25', header: '‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô 25%', type: 'number', isEditable: true },
            { key: '‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', header: '‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', type: 'calculated', isSummary: true, isTotalExpense: true },
            { key: '‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô', header: '‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô', type: 'calculated', isSummary: true, isNetTransfer: true },
            { key: 'action', header: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', type: 'action' }
        ];

        // --- Core Calculation Logic (All calculations use the stored NET amounts) ---
        function calculateSummary(record) {
            // Get value using the new key '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö' (which stores the NET amount)
            const getNum = (key) => parseFloat(record[key] || 0);

            // 1. ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (Total Expenses - all are NET/Pre-VAT)
            const totalExpenses = getNum('‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤3') + getNum('‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥') + getNum('‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü') + getNum('‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï') + 
                                  getNum('‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á') + getNum('‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢') + getNum('‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô25');

            // 2. ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô (Net Transfer Amount = Income NET - Expenses NET)
            const netTransfer = getNum('‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö') - totalExpenses;
            
            // Update the record object with calculated values
            record.‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ = totalExpenses.toFixed(2);
            record.‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô = netTransfer.toFixed(2);
            
            return record;
        }

        // --- UI Rendering ---
        window.renderTable = (records) => {
            const tableBody = document.getElementById('table-body');
            const tableHeaderRow = document.getElementById('table-header-row');
            const tableSummaryRow = document.getElementById('table-summary-row');
            tableBody.innerHTML = '';
            tableHeaderRow.innerHTML = '';
            tableSummaryRow.innerHTML = '';

            if (records.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state').classList.add('hidden');

            // 1. Render Header
            COLUMN_CONFIG.filter(col => col.type !== 'hidden').forEach(col => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-blue-50';
                th.textContent = col.header;
                tableHeaderRow.appendChild(th);
            });

            // 2. Render Data Rows
            let totalSummary = COLUMN_CONFIG.reduce((acc, col) => {
                if (col.type === 'number' || col.isSummary) {
                    acc[col.key] = 0;
                }
                return acc;
            }, {});

            records.forEach((rawRecord, index) => {
                const record = calculateSummary({ ...rawRecord }); // Recalculate for display and summary
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';

                COLUMN_CONFIG.filter(col => col.type !== 'hidden').forEach(col => {
                    const cell = document.createElement('td');
                    cell.className = 'px-4 py-3 whitespace-nowrap';

                    if (col.key === 'action') {
                        const editBtn = document.createElement('button');
                        editBtn.textContent = '...';
                        editBtn.onclick = () => openModal('edit', record.id);
                        editBtn.className = 'text-blue-600 hover:text-blue-900 font-bold p-1 rounded-full hover:bg-blue-100 transition';
                        cell.appendChild(editBtn);
                    } else {
                        let value = record[col.key] !== undefined ? record[col.key] : '';

                        if (col.type === 'number' || col.type === 'calculated') {
                            // For display, convert Income back to GROSS for the user's view
                            let displayValue = parseFloat(value);
                            if (col.key === '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö') {
                                displayValue = toGross(displayValue);
                            }

                            value = displayValue.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            cell.className += ' text-right font-mono';
                            
                            // Accumulate for summary (only original numbers and net transfer/total expenses)
                            if (col.type === 'number' || col.isTotalExpense || col.isNetTransfer) {
                                totalSummary[col.key] += parseFloat(record[col.key]);
                            }

                            // Highlight Net Transfer column (‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô)
                            if (col.isNetTransfer) {
                                cell.className += parseFloat(record[col.key]) < 0 ? ' text-red-600' : ' text-green-600';
                                cell.innerHTML = `<span class="font-extrabold">${value}</span>`;
                            } else {
                                cell.textContent = value;
                            }
                            
                        } else {
                            cell.textContent = value;
                        }
                    }
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });

            // 3. Render Summary Row
            const summaryRow = document.createElement('tr');
            
            COLUMN_CONFIG.filter(col => col.type !== 'hidden').forEach(col => {
                const cell = document.createElement('td');
                cell.className = 'px-4 py-3 whitespace-nowrap font-extrabold border-t border-gray-300';
                
                if (col.isSummary) {
                    if (col.key === 'month') {
                        cell.textContent = col.summaryLabel;
                        cell.className += ' text-left text-blue-700';
                    } else if (col.key !== 'isoDate') {
                        let total = totalSummary[col.key];

                        // For summary row, convert Income total back to GROSS for display
                        if (col.key === '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö') {
                            total = toGross(total);
                        }

                        const displayValue = total.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        cell.textContent = displayValue;
                        cell.className += ' text-right font-mono';
                        
                        if (col.isNetTransfer) {
                            cell.className += total < 0 ? ' text-red-700' : ' text-green-700';
                            cell.innerHTML = `<span>${displayValue}</span>`;
                        } else if (col.isTotalExpense) {
                            cell.className += ' text-red-700';
                        }
                    }
                } else {
                    cell.textContent = ''; // Empty cell for non-summary/non-display columns
                }
                summaryRow.appendChild(cell);
            });
            tableSummaryRow.appendChild(summaryRow);
        };
        
        // --- CRUD Operations (Local Storage) ---
        const recordForm = document.getElementById('record-form');
        recordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const docId = document.getElementById('record-id').value;
            const inputDateStr = document.getElementById('input-date').value;

            // Enforce day 1 for storage and conversion
            const dateParts = inputDateStr.split('-');
            const isoDate = `${dateParts[0]}-${dateParts[1]}-01`;
            
            // Generate Thai display month
            const thaiMonth = convertDateToThaiFormat(isoDate);

            const newRecordData = {
                month: thaiMonth, // Thai formatted month for display
                isoDate: isoDate   // Full ISO date for chronological sorting
            };
            
            // Capture all number inputs based on CONFIG
            COLUMN_CONFIG.filter(c => c.isEditable && c.type === 'number').forEach(col => {
                const input = document.getElementById(col.key);
                let value = parseFloat(input.value || 0);

                if (col.key === '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö') {
                    // CONVERSION: Convert Gross Income (from form) to Net Income (for storage)
                    value = toNet(value);
                }
                
                newRecordData[col.key] = value;
            });
            
            let records = window.dataStore;

            if (docId) {
                // Update existing record
                const index = records.findIndex(r => r.id === docId);
                if (index !== -1) {
                    records[index] = { ...records[index], ...newRecordData };
                }
            } else {
                // Create new record
                newRecordData.id = 'local-' + Date.now() + Math.random().toString(16).slice(2); // Generate unique ID
                records.push(newRecordData);
            }
            
            // Sort and Save to Local Storage
            records.sort((a, b) => (a.isoDate > b.isoDate) ? 1 : -1);
            saveRecordsToLocalStorage(records);
            window.dataStore = records;
            window.renderTable(records);
            
            closeModal();
        });
        
        window.deleteRecord = () => {
            const docId = document.getElementById('record-id').value;
            if (docId) {
                showConfirmModal("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ", (confirmed) => {
                    if (confirmed) {
                        let records = window.dataStore;
                        // Filter out the deleted record
                        records = records.filter(r => r.id !== docId);

                        // Save and Re-render
                        saveRecordsToLocalStorage(records);
                        window.dataStore = records;
                        window.renderTable(records);
                        
                        closeModal();
                    }
                });
            }
        };

        // --- Modal & UI Management ---
        window.openModal = (mode, id = null) => {
            const modal = document.getElementById('data-modal');
            const title = document.getElementById('modal-title');
            const deleteBtn = document.getElementById('delete-btn');
            const recordIdInput = document.getElementById('record-id');
            const form = document.getElementById('record-form');
            const inputDate = document.getElementById('input-date');

            form.reset();
            recordIdInput.value = '';
            deleteBtn.classList.add('hidden');
            
            if (mode === 'edit' && id) {
                title.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
                recordIdInput.value = id;
                deleteBtn.classList.remove('hidden');

                const record = window.dataStore.find(r => r.id === id);
                if (record) {
                    // Set date input using stored isoDate
                    inputDate.value = record.isoDate || '';
                    
                    // Populate number inputs
                    COLUMN_CONFIG.filter(c => c.isEditable && c.type === 'number').forEach(col => {
                        const input = document.getElementById(col.key);
                        let value = record[col.key] !== undefined ? record[col.key] : 0;
                        
                        if (col.key === '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö') {
                            // CONVERSION: Convert Net Income (from storage) back to Gross Income (for form display)
                            value = toGross(value);
                        }

                        input.value = value.toFixed(2);
                    });
                }
            } else {
                title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà';
                // Set default date to the 1st of the current month
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                inputDate.value = `${year}-${month}-01`;
                
                // Set default values for number inputs
                COLUMN_CONFIG.filter(c => c.isEditable && c.type === 'number').forEach(col => {
                    document.getElementById(col.key).value = 0;
                });
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.closeModal = () => {
            const modal = document.getElementById('data-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('record-form').reset();
        };
        
        // --- Custom Alert/Confirmation Dialog ---
        let resolvePromise;
        window.confirmCallback = (result) => {
            document.getElementById('alert-modal').classList.add('hidden');
            document.getElementById('alert-modal').classList.remove('flex');
            if (resolvePromise) {
                resolvePromise(result);
            }
        };

        function showConfirmModal(message, callback) {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-modal').classList.remove('hidden');
            document.getElementById('alert-modal').classList.add('flex');
            
            return new Promise(resolve => {
                resolvePromise = resolve;
                window.confirmCallback = (result) => {
                    document.getElementById('alert-modal').classList.add('hidden');
                    document.getElementById('alert-modal').classList.remove('flex');
                    resolve(result);
                    if (callback) callback(result);
                };
            });
        }


        // --- Excel Import/Export Logic (using SheetJS/XLSX) ---

        // Map column keys to Thai headers for file export
        const EXPORT_HEADERS = COLUMN_CONFIG
            .filter(c => c.key !== 'action' && c.type !== 'hidden')
            .map(c => ({ key: c.key, header: c.header }));

        window.exportData = () => {
            if (window.dataStore.length === 0) {
                showConfirmModal("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô", (r) => {});
                return;
            }

            // 1. Prepare data for Excel
            const exportDataArray = window.dataStore.map(record => {
                const calculatedRecord = calculateSummary({ ...record });
                const obj = {};
                
                // Include isoDate for data integrity in export, use '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ISO' as header
                obj['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ISO'] = calculatedRecord.isoDate; 

                EXPORT_HEADERS.forEach(col => {
                    let value = calculatedRecord[col.key] !== undefined ? calculatedRecord[col.key] : '';
                    
                    // For Income, export the GROSS amount for consistency with user input method
                    if (col.key === '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö') {
                        value = toGross(parseFloat(value));
                    }

                    if (col.type === 'number' || col.type === 'calculated') {
                        value = parseFloat(value); // Keep as number for Excel
                    }
                    obj[col.header] = value; // Use Thai header as key
                });
                return obj;
            });
            
            // 2. Define headers for Excel in desired order (Thai headers + ISO date for context)
            const finalExportHeaders = EXPORT_HEADERS.map(h => h.header);
            finalExportHeaders.splice(1, 0, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ISO'); // Insert ISO Date after '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'
            
            // 3. Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportDataArray, { header: finalExportHeaders });
            
            // 4. Create workbook and download
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢");
            XLSX.writeFile(wb, "‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢_Export.xlsx");
        };

        window.importData = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convert sheet to JSON array
                const importedJson = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (importedJson.length < 2) {
                    showConfirmModal("‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤", (r) => {});
                    return;
                }

                const importedHeaders = importedJson[0];
                const dataRows = importedJson.slice(1);
                const recordsToSave = [];

                // Mapping imported Thai headers back to internal keys
                const headerMap = COLUMN_CONFIG
                    .filter(c => c.key !== 'action' && c.type !== 'hidden')
                    .reduce((map, col) => {
                        map[col.header] = col.key;
                        return map;
                    }, {});
                
                // Add the internal ISO date key to the map for proper import handling
                headerMap['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ISO'] = 'isoDate';

                // Process rows
                dataRows.forEach(row => {
                    const newRecord = {};
                    let isValidRow = false;
                    
                    importedHeaders.forEach((header, index) => {
                        const internalKey = headerMap[header];
                        if (internalKey) {
                            let value = row[index];

                            if (internalKey === 'isoDate' && typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                // Use the ISO date for sorting
                                newRecord[internalKey] = value; 
                                newRecord.month = convertDateToThaiFormat(value);
                                isValidRow = true;
                            } else if (internalKey === 'isoDate' && !value) {
                                // Skip this row if critical 'isoDate' is missing for sorting
                            } else if (internalKey !== 'month') { 
                                // Handle number inputs
                                if (typeof value === 'number') {
                                    if (internalKey === '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö') {
                                        // CONVERSION: Income from Excel is GROSS, convert to NET for storage
                                        value = toNet(value); 
                                    }
                                    newRecord[internalKey] = value;
                                } else if (value) {
                                    let numValue = parseFloat(value) || 0;
                                    if (internalKey === '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ã‡∏±‡∏Å‡∏≠‡∏ö') {
                                        // CONVERSION: Income from Excel is GROSS, convert to NET for storage
                                        numValue = toNet(numValue);
                                    }
                                    newRecord[internalKey] = numValue;
                                } else {
                                    newRecord[internalKey] = 0; // Default zero for missing numbers
                                }
                            }
                        }
                    });
                    
                    if (isValidRow) {
                        // Assign a new local ID
                        newRecord.id = 'local-' + Date.now() + Math.random().toString(16).slice(2);
                        // Apply calculations to ensure data integrity before saving
                        const finalRecord = calculateSummary(newRecord); 
                        recordsToSave.push(finalRecord);
                    }
                });

                if (recordsToSave.length === 0) {
                    showConfirmModal("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ISO' ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏±‡πâ‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà", (r) => {});
                    return;
                }

                // *** Batch Save to Local Storage ***
                showConfirmModal(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${recordsToSave.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£. ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)`, (confirmed) => {
                    if (confirmed) {
                        try {
                            // Sort and Save to Local Storage
                            recordsToSave.sort((a, b) => (a.isoDate > b.isoDate) ? 1 : -1);
                            saveRecordsToLocalStorage(recordsToSave);
                            window.dataStore = recordsToSave;
                            window.renderTable(recordsToSave);
                            
                            showConfirmModal("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!", (r) => {});
                        } catch (error) {
                            console.error("Batch import failed:", error);
                            showConfirmModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + error.message, (r) => {});
                        }
                    }
                });
            };

            reader.onerror = (error) => {
                console.error("File reading error:", error);
                showConfirmModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå", (r) => {});
            };

            reader.readAsBinaryString(file);
        };
        
        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load data from localStorage on startup
            window.dataStore = loadRecordsFromLocalStorage();
            
            // Sort data chronologically for display
            window.dataStore.sort((a, b) => (a.isoDate > b.isoDate) ? 1 : -1);
            
            window.renderTable(window.dataStore);
            
            // Hide loading overlay and show content
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('main-app-content').classList.remove('hidden');
        });
    </script>
</body>
</html>
